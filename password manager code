import os
import json
import getpass
import pyperclip
from cryptography.fernet import Fernet
import base64
import hashlib

VAULT_FILE = "vault.enc"
AUTH_FILE = "auth.hash"

def derive_key(password: str) -> bytes:
    # Derive a key from the master password for encryption
    salt = b"some_salt_"  # In real use, use a random salt stored safely
    kdf = hashlib.pbkdf2_hmac('sha256', password.encode(), salt, 100000)
    return base64.urlsafe_b64encode(kdf)

def save_auth_hash(password):
    # Save a hash of the master password for verification
    hash = hashlib.sha256(password.encode()).hexdigest()
    with open(AUTH_FILE, "w") as f:
        f.write(hash)

def check_auth():
    if not os.path.exists(AUTH_FILE):
        return False
    saved_hash = open(AUTH_FILE).read()
    password = getpass.getpass("Enter master password: ")
    input_hash = hashlib.sha256(password.encode()).hexdigest()
    if input_hash == saved_hash:
        return password
    else:
        print("Incorrect master password!")
        return False

def encrypt_data(data, key):
    f = Fernet(key)
    return f.encrypt(data.encode())

def decrypt_data(token, key):
    f = Fernet(key)
    return f.decrypt(token).decode()

def load_vault(key):
    if not os.path.exists(VAULT_FILE):
        return {}
    with open(VAULT_FILE, "rb") as f:
        encrypted = f.read()
    try:
        decrypted = decrypt_data(encrypted, key)
        return json.loads(decrypted)
    except Exception:
        print("Failed to decrypt vault. Possibly wrong master password or corrupted vault.")
        return {}

def save_vault(vault, key):
    data = json.dumps(vault)
    encrypted = encrypt_data(data, key)
    with open(VAULT_FILE, "wb") as f:
        f.write(encrypted)

def generate_password(length=16):
    import random
    import string
    chars = string.ascii_letters + string.digits + string.punctuation
    return ''.join(random.choice(chars) for _ in range(length))

def main():
    print("=== Password Manager ===")

    # Check if master password set
    if not os.path.exists(AUTH_FILE):
        print("No master password set. Create one now.")
        while True:
            pw1 = getpass.getpass("Create master password: ")
            pw2 = getpass.getpass("Confirm master password: ")
            if pw1 == pw2 and pw1.strip():
                save_auth_hash(pw1)
                print("Master password set.")
                break
            else:
                print("Passwords do not match or empty, try again.")
    else:
        pw = check_auth()
        if not pw:
            return

    key = derive_key(pw)
    vault = load_vault(key)

    while True:
        print("\nOptions:")
        print("1. Add password")
        print("2. Get password")
        print("3. Generate password")
        print("4. Exit")

        choice = input("Choose option: ").strip()

        if choice == '1':
            site = input("Enter site name: ").strip()
            pwd = getpass.getpass("Enter password (leave blank to generate): ")
            if not pwd:
                pwd = generate_password()
                print(f"Generated password: {pwd}")
            vault[site] = pwd
            save_vault(vault, key)
            print(f"Password saved for {site}.")

        elif choice == '2':
            site = input("Enter site name to retrieve: ").strip()
            if site in vault:
                pyperclip.copy(vault[site])
                print(f"Password for {site} copied to clipboard.")
            else:
                print("Site not found.")

        elif choice == '3':
            length = input("Password length (default 16): ").strip()
            length = int(length) if length.isdigit() else 16
            pwd = generate_password(length)
            pyperclip.copy(pwd)
            print(f"Generated password copied to clipboard: {pwd}")

        elif choice == '4':
            print("Exiting.")
            break

        else:
            print("Invalid option, try again.")

if __name__ == "__main__":
    main()
